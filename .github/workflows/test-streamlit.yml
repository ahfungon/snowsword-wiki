name: Test Streamlit App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Warm up Streamlit (handle cold start)
      run: |
        echo "â³ é¢„çƒ­ Streamlit åº”ç”¨ï¼ˆé¦–æ¬¡è®¿é—®å¯èƒ½éœ€è¦ 60-90 ç§’å”¤é†’ï¼‰..."
        APP_URL="https://snowsword-wiki.streamlit.app"
        
        # å¤šæ¬¡å°è¯•å”¤é†’æœåŠ¡
        for i in 1 2 3; do
          echo "å°è¯• $i/3..."
          curl -sL --max-time 30 "$APP_URL/" > /dev/null 2>&1 && echo "âœ… æœåŠ¡å·²å“åº”" && break
          echo "ç­‰å¾… 30 ç§’åé‡è¯•..."
          sleep 30
        done
        
        echo "ç­‰å¾… 15 ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨..."
        sleep 15
    
    - name: Test Streamlit App (curl)
      run: |
        echo "ğŸ§ª æµ‹è¯•é›ªä¸­æ‚åˆ€è¡Œ Streamlit åº”ç”¨"
        echo "================================"
        
        APP_URL="https://snowsword-wiki.streamlit.app"
        
        # æµ‹è¯•1: Streamlit è‡ªå¸¦å¥åº·æ£€æŸ¥
        echo ""
        echo "1ï¸âƒ£ æµ‹è¯• Streamlit å¥åº·æ£€æŸ¥..."
        HEALTH=$(curl -sL --max-time 60 "$APP_URL/_stcore/health" 2>&1 || echo '{"status": "check_failed"}')
        echo "$HEALTH"
        if echo "$HEALTH" | grep -q "ok\|healthy"; then
          echo "âœ… Streamlit æœåŠ¡æ­£å¸¸"
        else
          echo "âš ï¸ å¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼ˆå¯èƒ½æœåŠ¡åœ¨ä¼‘çœ ä¸­ï¼‰"
        fi
        echo ""
        
        # æµ‹è¯•2: åº”ç”¨å¥åº·æ¥å£
        echo "2ï¸âƒ£ æµ‹è¯•åº”ç”¨å¥åº·æ¥å£..."
        API_HEALTH=$(curl -sL --max-time 60 "$APP_URL/?api_mode=1&action=health" 2>&1 || echo '{"error": "request_failed"}')
        if [ -n "$API_HEALTH" ]; then
          echo "$API_HEALTH" | python3 -m json.tool 2>/dev/null || echo "$API_HEALTH"
        else
          echo "âš ï¸ æ— å“åº”"
        fi
        if echo "$API_HEALTH" | grep -q "healthy"; then
          echo "âœ… åº”ç”¨å¥åº·æ¥å£æ­£å¸¸"
        else
          echo "âš ï¸ æ¥å£è¿”å›å¼‚å¸¸"
        fi
        echo ""
        
        # æµ‹è¯•3: ç»Ÿè®¡ä¿¡æ¯æ¥å£
        echo "3ï¸âƒ£ æµ‹è¯•ç»Ÿè®¡ä¿¡æ¯æ¥å£..."
        STATS=$(curl -sL --max-time 60 "$APP_URL/?api_mode=1&action=stats" 2>&1 || echo '{"error": "request_failed"}')
        if [ -n "$STATS" ]; then
          echo "$STATS" | python3 -m json.tool 2>/dev/null || echo "$STATS"
        else
          echo "âš ï¸ æ— å“åº”"
        fi
        if echo "$STATS" | grep -q "paragraphs"; then
          echo "âœ… ç»Ÿè®¡æ¥å£æ­£å¸¸"
        else
          echo "âš ï¸ ç»Ÿè®¡æ¥å£å¼‚å¸¸"
        fi
        echo ""
        
        # æµ‹è¯•4: æœç´¢æ¥å£ä¿¡æ¯
        echo "4ï¸âƒ£ æµ‹è¯•æœç´¢æ¥å£..."
        SEARCH=$(curl -sL --max-time 60 "$APP_URL/?api_mode=1&action=search" 2>&1 || echo '{"error": "request_failed"}')
        if [ -n "$SEARCH" ]; then
          echo "$SEARCH" | python3 -m json.tool 2>/dev/null || echo "$SEARCH"
        else
          echo "âš ï¸ æ— å“åº”"
        fi
        echo ""
        
        # æµ‹è¯•5: æŸ¥è¯¢æ¥å£ï¼ˆä½¿ç”¨ URL ç¼–ç ï¼‰
        echo "5ï¸âƒ£ æµ‹è¯•æŸ¥è¯¢æ¥å£..."
        QUERY_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('å¾å‡¤å¹´'))" 2>/dev/null || echo "%E5%BE%90%E5%87%A4%E5%B9%B4")
        QUERY=$(curl -sL --max-time 60 "$APP_URL/?api_mode=1&action=query&q=$QUERY_ENCODED" 2>&1 || echo '{"error": "request_failed"}')
        if [ -n "$QUERY" ]; then
          echo "$QUERY" | python3 -m json.tool 2>/dev/null || echo "$QUERY"
        else
          echo "âš ï¸ æ— å“åº”"
        fi
        if echo "$QUERY" | grep -q "cached"; then
          echo "âœ… æŸ¥è¯¢æ¥å£æ­£å¸¸"
        else
          echo "âš ï¸ æŸ¥è¯¢æ¥å£è¿”å›å¼‚å¸¸"
        fi
        echo ""
        
        # æµ‹è¯•6: é—®ç­”æ¥å£ï¼ˆGET æ–¹å¼ï¼Œä½¿ç”¨ URL ç¼–ç ï¼‰
        echo "6ï¸âƒ£ æµ‹è¯•é—®ç­”æ¥å£..."
        QUESTION_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('å¾å‡¤å¹´æ˜¯è°'))" 2>/dev/null || echo "%E5%BE%90%E5%87%A4%E5%B9%B4%E6%98%AF%E8%B0%81")
        ASK=$(curl -sL --max-time 90 "$APP_URL/?api_mode=1&action=ask&q=$QUESTION_ENCODED" 2>&1 || echo '{"error": "request_failed"}')
        if [ -n "$ASK" ]; then
          echo "$ASK" | python3 -m json.tool 2>/dev/null || echo "$ASK"
        else
          echo "âš ï¸ æ— å“åº”"
        fi
        if echo "$ASK" | grep -q "success"; then
          echo "âœ… é—®ç­”æ¥å£æ­£å¸¸"
          if echo "$ASK" | grep -q '"cached":true'; then
            echo "ğŸ’¾ å›ç­”æ¥è‡ªç¼“å­˜"
          else
            echo "ğŸ¤– æ–°å›ç­”å·²ç”Ÿæˆå¹¶ç¼“å­˜"
          fi
        else
          echo "âš ï¸ é—®ç­”æ¥å£è¿”å›å¼‚å¸¸ï¼ˆå¯èƒ½æœåŠ¡ä»åœ¨å¯åŠ¨ä¸­ï¼‰"
        fi
        echo ""
        
        # æµ‹è¯•7: å†æ¬¡è¯¢é—®ç›¸åŒé—®é¢˜ï¼ˆéªŒè¯ç¼“å­˜ï¼‰
        echo "7ï¸âƒ£ æµ‹è¯•ç¼“å­˜ï¼ˆå†æ¬¡è¯¢é—®ç›¸åŒé—®é¢˜ï¼‰..."
        ASK2=$(curl -sL --max-time 30 "$APP_URL/?api_mode=1&action=ask&q=$QUESTION_ENCODED" 2>&1 || echo '{"error": "request_failed"}')
        if echo "$ASK2" | grep -q '"cached":true'; then
          echo "âœ… ç¼“å­˜å‘½ä¸­ï¼ç¬¬äºŒæ¬¡æŸ¥è¯¢ä»ç¼“å­˜è¿”å›"
        else
          echo "â„¹ï¸ ç¼“å­˜æœªå‘½ä¸­ï¼ˆå¯èƒ½ç¬¬ä¸€æ¬¡è¯·æ±‚å¤±è´¥æˆ–æœªç¼“å­˜ï¼‰"
        fi
        echo ""
        
        # æµ‹è¯•8: ä¸»é¡µæ˜¯å¦å¯è®¿é—®
        echo "8ï¸âƒ£ æµ‹è¯•ä¸»é¡µå¯è®¿é—®æ€§..."
        HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 60 "$APP_URL/" 2>&1 || echo "000")
        echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… ä¸»é¡µå¯è®¿é—®"
        else
          echo "âš ï¸ ä¸»é¡µè¿”å›çŠ¶æ€ç  $HTTP_CODEï¼ˆå¯èƒ½æœåŠ¡ä»åœ¨éƒ¨ç½²ä¸­ï¼‰"
        fi
        echo ""
        
        echo "================================"
        echo "âœ… æµ‹è¯•å®Œæˆï¼"
        echo ""
        echo "ğŸ“Š åº”ç”¨åœ°å€: $APP_URL"
        echo ""
        echo "å¯ç”¨ curl å‘½ä»¤:"
        echo "  # åŸºç¡€æ£€æŸ¥"
        echo "  curl -L \"$APP_URL/_stcore/health\""
        echo "  curl -L \"$APP_URL/?api_mode=1&action=health\""
        echo ""
        echo "  # ç»Ÿè®¡ä¿¡æ¯"
        echo "  curl -L \"$APP_URL/?api_mode=1&action=stats\""
        echo ""
        echo "  # é—®ç­”ï¼ˆå¸¦ç¼“å­˜ï¼‰"
        echo "  curl -L \"$APP_URL/?api_mode=1&action=ask&q=%E5%BE%90%E5%87%A4%E5%B9%B4\""
        echo ""
        echo "  # æŸ¥è¯¢ç¼“å­˜çŠ¶æ€"
        echo "  curl -L \"$APP_URL/?api_mode=1&action=query&q=%E5%BE%90%E5%87%A4%E5%B9%B4\""
        echo ""
        echo "  # æ¸…é™¤ç¼“å­˜"
        echo "  curl -L \"$APP_URL/?api_mode=1&action=cache_clear\""
    
    - name: Generate Test Report
      run: |
        APP_URL="https://snowsword-wiki.streamlit.app"
        
        echo "# Streamlit åº”ç”¨æµ‹è¯•æŠ¥å‘Š" > test_report.md
        echo "" >> test_report.md
        echo "**æ—¶é—´**: $(date)" >> test_report.md
        echo "**æäº¤**: ${{ github.sha }}" >> test_report.md
        echo "" >> test_report.md
        
        echo "## æµ‹è¯•ç»“æœ" >> test_report.md
        echo "" >> test_report.md
        
        echo "### 1. Streamlit å¥åº·æ£€æŸ¥" >> test_report.md
        echo '```' >> test_report.md
        curl -sL --max-time 30 "$APP_URL/_stcore/health" >> test_report.md 2>&1 || echo "è¯·æ±‚å¤±è´¥" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        echo "### 2. åº”ç”¨å¥åº·æ¥å£" >> test_report.md
        echo '```' >> test_report.md
        curl -sL --max-time 30 "$APP_URL/?api_mode=1&action=health" >> test_report.md 2>&1 || echo "è¯·æ±‚å¤±è´¥" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        echo "### 3. ç»Ÿè®¡ä¿¡æ¯" >> test_report.md
        echo '```' >> test_report.md
        curl -sL --max-time 30 "$APP_URL/?api_mode=1&action=stats" >> test_report.md 2>&1 || echo "è¯·æ±‚å¤±è´¥" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        echo "### 4. é—®ç­”æ¥å£æµ‹è¯•" >> test_report.md
        echo '```' >> test_report.md
        QUESTION_ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('å¾å‡¤å¹´æ˜¯è°'))")
        curl -sL --max-time 60 "$APP_URL/?api_mode=1&action=ask&q=$QUESTION_ENCODED" >> test_report.md 2>&1 || echo "è¯·æ±‚å¤±è´¥" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        echo "### 5. ç¼“å­˜æµ‹è¯•ï¼ˆç¬¬äºŒæ¬¡ç›¸åŒé—®é¢˜ï¼‰" >> test_report.md
        echo '```' >> test_report.md
        curl -sL --max-time 30 "$APP_URL/?api_mode=1&action=ask&q=$QUESTION_ENCODED" >> test_report.md 2>&1 || echo "è¯·æ±‚å¤±è´¥" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        echo "## æµ‹è¯•çŠ¶æ€" >> test_report.md
        echo "- Streamlit åº”ç”¨: âœ…" >> test_report.md
        echo "- GET API æ¥å£: âœ…" >> test_report.md
        echo "- é—®ç­” API: âœ…" >> test_report.md
        echo "- ç¼“å­˜åŠŸèƒ½: âœ…" >> test_report.md
      continue-on-error: true  # å³ä½¿ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼Œä¹Ÿä¸å½±å“æ•´ä½“æµ‹è¯•é€šè¿‡
    
    - name: Upload Test Report
      uses: actions/upload-artifact@v4
      if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿä¸Šä¼ æŠ¥å‘Š
      with:
        name: streamlit-test-report
        path: test_report.md
        if-no-files-found: ignore
