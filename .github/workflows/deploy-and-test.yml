name: Deploy & Test API

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # æ–¹æ¡ˆ1: éƒ¨ç½²åˆ° Render (æŽ¨èå…è´¹æ–¹æ¡ˆ)
    - name: Deploy to Render
      if: github.ref == 'refs/heads/main'
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "ðŸš€ è§¦å‘ Render éƒ¨ç½²..."
        curl -X POST \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -H "accept: application/json" \
          -H "authorization: Bearer $RENDER_API_KEY" \
          -H "content-type: application/json" \
          -d '{}'
        echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ (30ç§’)..."
        sleep 30
      continue-on-error: true
    
    # æ–¹æ¡ˆ2: éƒ¨ç½²åˆ° Railway (å¤‡é€‰)
    - name: Deploy to Railway
      if: github.ref == 'refs/heads/main'
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        echo "ðŸš€ Railway ä¼šè‡ªåŠ¨ä»Ž GitHub éƒ¨ç½²"
        echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        sleep 45
      continue-on-error: true
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    - name: Wait for deployment
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
        sleep 30
    
    # ä½¿ç”¨ curl æµ‹è¯•å·²éƒ¨ç½²çš„ API
    - name: Test Deployed API
      env:
        API_BASE_URL: ${{ secrets.API_BASE_URL }}
      run: |
        echo "ðŸ§ª æµ‹è¯•å·²éƒ¨ç½²çš„ API..."
        echo "APIåœ°å€: $API_BASE_URL"
        echo ""
        
        # æµ‹è¯•1: æ ¹è·¯å¾„
        echo "1ï¸âƒ£ æµ‹è¯•æ ¹è·¯å¾„..."
        curl -s "$API_BASE_URL/" | jq '.' || curl -s "$API_BASE_URL/"
        echo ""
        
        # æµ‹è¯•2: å¥åº·æ£€æŸ¥
        echo "2ï¸âƒ£ æµ‹è¯•å¥åº·æ£€æŸ¥..."
        HEALTH=$(curl -s "$API_BASE_URL/health")
        echo "$HEALTH" | jq '.' || echo "$HEALTH"
        if echo "$HEALTH" | grep -q "healthy"; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸ å¥åº·æ£€æŸ¥æœªé€šè¿‡"
        fi
        echo ""
        
        # æµ‹è¯•3: æœç´¢æŽ¥å£
        echo "3ï¸âƒ£ æµ‹è¯•æœç´¢æŽ¥å£..."
        SEARCH=$(curl -s "$API_BASE_URL/search?q=å¾å‡¤å¹´&top_k=2")
        echo "$SEARCH" | jq '.' || echo "$SEARCH"
        if echo "$SEARCH" | grep -q "results"; then
          echo "âœ… æœç´¢æŽ¥å£æ­£å¸¸"
        else
          echo "âš ï¸ æœç´¢æŽ¥å£å¼‚å¸¸"
        fi
        echo ""
        
        # æµ‹è¯•4: æŸ¥è¯¢æŽ¥å£ (POST)
        echo "4ï¸âƒ£ æµ‹è¯•æŸ¥è¯¢æŽ¥å£..."
        QUERY=$(curl -s -X POST "$API_BASE_URL/query" \
          -H "Content-Type: application/json" \
          -d '{"query":"å¾å‡¤å¹´æ˜¯è°","top_k":3,"temperature":0.7}')
        echo "$QUERY" | jq '.answer' || echo "$QUERY"
        if echo "$QUERY" | grep -q "answer"; then
          echo "âœ… æŸ¥è¯¢æŽ¥å£æ­£å¸¸"
        else
          echo "âš ï¸ æŸ¥è¯¢æŽ¥å£å¼‚å¸¸"
        fi
        echo ""
        
        echo "ðŸŽ‰ API æµ‹è¯•å®Œæˆï¼"
    
    # ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
    - name: Generate Test Report
      env:
        API_BASE_URL: ${{ secrets.API_BASE_URL }}
      run: |
        echo "# API æµ‹è¯•æŠ¥å‘Š" > test_report.md
        echo "æ—¶é—´: $(date)" >> test_report.md
        echo "æäº¤: ${{ github.sha }}" >> test_report.md
        echo "" >> test_report.md
        echo "## æµ‹è¯•ç»“æžœ" >> test_report.md
        echo "" >> test_report.md
        
        # æ ¹è·¯å¾„
        echo "### æ ¹è·¯å¾„" >> test_report.md
        echo '```json' >> test_report.md
        curl -s "$API_BASE_URL/" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        # å¥åº·æ£€æŸ¥
        echo "### å¥åº·æ£€æŸ¥" >> test_report.md
        echo '```json' >> test_report.md
        curl -s "$API_BASE_URL/health" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
        echo "" >> test_report.md
        
        # æœç´¢
        echo "### æœç´¢æµ‹è¯•" >> test_report.md
        echo '```json' >> test_report.md
        curl -s "$API_BASE_URL/search?q=å¾å‡¤å¹´&top_k=2" >> test_report.md
        echo '' >> test_report.md
        echo '```' >> test_report.md
    
    - name: Upload Test Report
      uses: actions/upload-artifact@v4
      with:
        name: api-test-report
        path: test_report.md
