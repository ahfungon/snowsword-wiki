# 《雪中悍刀行》智能百科 - 项目实施方案

## 📋 项目概述

### 项目目标
构建一个基于《雪中悍刀行》小说的**专家级AI问答系统**，实现：
- 深度理解小说内容，超越简单的关键词匹配
- 具备文学评论家级别的分析能力
- 能回答复杂的人物关系、情节因果、主题象征问题
- 回答自然、有深度、可追溯原文

### 当前状态
- ✅ 基础问答功能已实现
- ✅ 初步知识图谱（14人物、3658事件）
- ✅ 专家级提示词（三段式结构）
- ❌ 知识库深度不足（基于章节摘要而非完整原文）
- ❌ 检索粒度较粗
- ❌ 缺乏动态关系网络

---

## 🏗️ 技术架构

### 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                      用户交互层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web界面    │  │   API接口    │  │   管理后台   │      │
│  │  (Streamlit) │  │   (FastAPI)  │  │  (可选)      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              专家级AI问答引擎                          │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │  │
│  │  │ 意图理解   │  │ 知识检索   │  │ 回答生成   │     │  │
│  │  │ 模块       │  │ 模块       │  │ 模块       │     │  │
│  │  └────────────┘  └────────────┘  └────────────┘     │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      知识管理层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   向量索引   │  │   图数据库   │  │   原文存储   │      │
│  │  (FAISS/    │  │   (Neo4j)    │  │   (JSON/     │      │
│  │   Chroma)    │  │              │  │   SQLite)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据处理层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   文本分块   │  │   NER抽取    │  │   关系构建   │      │
│  │   引擎       │  │   (HanLP)    │  │   引擎       │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. 数据处理层
| 组件 | 技术选型 | 用途 |
|------|----------|------|
| 文本分块 | 滑动窗口 + 语义边界 | 将小说分割成有语义完整性的块 |
| NER抽取 | HanLP / LTP | 识别人物、地点、组织、武功 |
| 关系抽取 | 依存句法分析 | 识别人物关系、事件因果 |
| 向量化 | BAAI/bge-large-zh | 中文语义嵌入 |

#### 2. 知识管理层
| 组件 | 技术选型 | 用途 |
|------|----------|------|
| 向量数据库 | ChromaDB / FAISS | 语义检索 |
| 图数据库 | Neo4j | 人物关系网络 |
| 文档存储 | JSON + SQLite | 原文、事件、引用索引 |
| 缓存 | Redis (可选) | 热点查询缓存 |

#### 3. 应用服务层
| 组件 | 技术选型 | 用途 |
|------|----------|------|
| 意图理解 | 规则 + 轻量分类器 | 识别问题类型 |
| 知识检索 | 混合检索(向量+图谱) | 召回相关知识 |
| 回答生成 | DeepSeek API | 生成专家级回答 |
| 提示词工程 | 三段式专家模板 | 控制回答质量 |

#### 4. 用户交互层
| 组件 | 技术选型 | 用途 |
|------|----------|------|
| Web界面 | Streamlit | 快速原型 |
| API服务 | FastAPI | 后续扩展 |

---

## 📅 实施阶段

### 阶段一：基础重构（Week 1）

#### 目标
用完整原文重建知识库，实现细粒度事件抽取

#### 任务清单
- [ ] **Day 1-2: 数据处理管道**
  - 集成 HanLP 进行 NER 和关系抽取
  - 实现智能文本分块（保持语义完整性）
  - 构建段落级索引（章节→段落→句子）

- [ ] **Day 3-4: 向量检索升级**
  - 集成 BGE 中文 Embedding
  - 替换现有检索器，实现语义检索
  - 评估检索质量（Top-K准确率）

- [ ] **Day 5-7: 事件抽取**
  - 提取人物事件（谁+什么时候+做了什么）
  - 提取对话内容（说话者+内容+上下文）
  - 提取关键场景（战斗、决策、转折）
  - 构建精确引用索引（关键词→原文段落）

#### 交付物
- `src/text_processor.py` - 文本处理管道
- `src/semantic_retriever.py` - 语义检索器
- `src/event_extractor.py` - 事件抽取器
- `data/events.json` - 结构化事件数据
- `data/quote_index.json` - 精确引用索引

---

### 阶段二：知识图谱（Week 2）

#### 目标
构建动态人物关系网络和情节因果图

#### 任务清单
- [ ] **Day 1-2: 人物关系网络**
  - 定义关系类型（亲属、师徒、敌对、同盟、情感）
  - 提取人物间关系（从对话和事件）
  - 关系强度量化（共同出场次数、互动情感）
  - 关系时间线（关系随情节的变化）

- [ ] **Day 3-4: 情节因果图**
  - 定义关键事件节点
  - 构建因果关系（A导致B）
  - 识别伏笔和回收（前文铺垫→后文揭晓）
  - 多线叙事追踪（并行情节线）

- [ ] **Day 5-7: 图谱存储与查询**
  - 集成 Neo4j 图数据库
  - 实现图谱可视化（NetworkX + PyVis）
  - 图查询接口（人物关系查询、最短路径）

#### 交付物
- `src/knowledge_graph_v2.py` - 增强版知识图谱
- `src/graph_visualizer.py` - 图谱可视化
- `data/knowledge_graph_v2.json` - 完整图谱数据
- `docker-compose.yml` - Neo4j 服务配置

---

### 阶段三：专家系统（Week 3）

#### 目标
实现专家级问答，具备深度分析能力

#### 任务清单
- [ ] **Day 1-2: 混合检索**
  - 融合语义检索 + 图谱检索
  - 实现多跳推理（A→B→C关系链）
  - 上下文组装（相关事件+关系+原文）

- [ ] **Day 3-4: 主题分析**
  - 主题关键词库构建
  - 主题强度时间曲线
  - 象征物追踪（北凉刀、桃花等）
  - 价值观对比分析（北凉vs离阳vs北莽）

- [ ] **Day 5-7: 回答优化**
  - 完善三段式提示词模板
  - 实现回答结构化（事实/分析/升华）
  - 添加引用溯源（回答中的观点可验证）
  - A/B测试不同提示词效果

#### 交付物
- `src/hybrid_retriever.py` - 混合检索器
- `src/theme_analyzer.py` - 主题分析器
- `src/expert_ai_v2.py` - 增强版专家AI
- `prompts/expert_v2.txt` - 优化后提示词

---

### 阶段四：优化部署（Week 4）

#### 目标
优化性能，完善界面，稳定部署

#### 任务清单
- [ ] **Day 1-2: 性能优化**
  - 向量索引优化（IVF/PQ量化）
  - 查询缓存（Redis）
  - 异步处理（Celery）
  - 响应时间 < 3秒

- [ ] **Day 3-4: 界面优化**
  - 优化Streamlit界面（响应式、移动端适配）
  - 添加知识图谱可视化组件
  - 添加主题曲线图表
  - 添加引用溯源展示

- [ ] **Day 5-7: 测试部署**
  - 单元测试覆盖核心功能
  - 集成测试（端到端问答）
  - 压力测试（并发查询）
  - 部署文档完善

#### 交付物
- `app_v2.py` - 优化后的主应用
- `tests/` - 测试套件
- `docs/deployment.md` - 部署文档
- 性能测试报告

---

## 🛠️ 技术选型详情

### 核心依赖

```txt
# 数据处理
hanlp>=2.1.0           # 中文NLP
ltp>=4.2.0             # 备选NLP工具
jieba>=0.42.1          # 分词（备用）

# 向量化与检索
sentence-transformers>=2.2.0  # Embedding
chromadb>=0.4.0        # 向量数据库
faiss-cpu>=1.7.4       # Facebook向量检索
flagembedding>=1.0.0   # BGE中文Embedding

# 知识图谱
neo4j>=5.0.0           # Neo4j Python驱动
networkx>=3.0          # 图分析
pyvis>=0.3.0           # 交互式图谱可视化

# Web框架
streamlit>=1.28.0      # Web界面
fastapi>=0.104.0       # API服务（可选）
uvicorn>=0.24.0        # ASGI服务器

# 工具
pandas>=2.0.0
numpy>=1.24.0
python-dotenv>=1.0.0
pydantic>=2.0.0

# 缓存与性能
redis>=5.0.0           # 缓存（可选）
celery>=5.3.0          # 任务队列（可选）
```

### 模型选择

| 用途 | 模型 | 大小 | 部署方式 |
|------|------|------|----------|
| NER/关系抽取 | HanLP | 100MB-1GB | 本地加载 |
| 中文Embedding | BAAI/bge-large-zh | 1.3GB | 本地加载 |
| 问答生成 | DeepSeek-V3 | - | API调用 |
| 备用问答 | ChatGLM3-6B | 12GB | 本地部署（可选） |

---

## 📊 评估指标

### 检索质量
- **召回率@10**: > 80%（正确答案在前10个检索结果中）
- **精确率@5**: > 60%（前5个结果相关）
- **MRR** (Mean Reciprocal Rank): > 0.4

### 回答质量（人工评估，抽样50题）
- **准确性**: > 85%（事实正确）
- **完整性**: > 80%（覆盖问题各个方面）
- **深度**: > 75%（有分析、有升华）
- **自然度**: > 80%（不像机器生成）
- **可追溯**: > 90%（关键观点有原文支撑）

### 性能指标
- **首次响应时间**: < 3秒
- **流式输出延迟**: < 500ms
- **并发支持**: > 10 QPS
- **内存占用**: < 4GB（运行时）

---

## 📝 数据规范

### 事件数据格式
```json
{
  "event_id": "evt_001",
  "type": "战斗/对话/决策/转折",
  "characters": ["徐凤年", "韩貂寺"],
  "location": "太安城外",
  "chapter": "第XXX章 XXX",
  "chapter_idx": 245,
  "paragraph_idx": 12,
  "content": "事件描述...",
  "context_before": "前文...",
  "context_after": "后文...",
  "cause_events": ["evt_000"],
  "effect_events": ["evt_002"],
  "sentiment": "激烈/悲伤/喜悦",
  "significance": 9.5,
  "keywords": ["复仇", "白衣案", "母亲"]
}
```

### 人物关系格式
```json
{
  "relation_id": "rel_001",
  "from": "徐凤年",
  "to": "韩貂寺",
  "type": "敌对/复仇",
  "strength": 0.95,
  "start_chapter": "回忆章节",
  "end_chapter": "第XXX章",
  "evidence": ["evt_001", "evt_002"],
  "description": "杀母之仇，不可调和"
}
```

### 引用索引格式
```json
{
  "keyword": "韩貂寺之死",
  "occurrences": [
    {
      "chapter": "第XXX章",
      "paragraph_idx": 15,
      "text": "原文段落...",
      "context": "前后文..."
    }
  ]
}
```

---

## 🎯 里程碑

| 日期 | 里程碑 | 验收标准 |
|------|--------|----------|
| Week 1结束 | 基础重构完成 | 语义检索可用，事件抽取准确率>70% |
| Week 2结束 | 知识图谱完成 | 人物关系可视化，因果查询可用 |
| Week 3结束 | 专家系统完成 | 回答质量评分>80分 |
| Week 4结束 | 部署上线 | 响应<3秒，无重大Bug |

---

## 🔧 开发环境

### 硬件要求
- **开发**: 16GB RAM, 50GB SSD, 可选GPU（加速Embedding）
- **部署**: 8GB RAM, 20GB SSD

### 软件环境
- Python 3.9+
- Docker & Docker Compose（Neo4j）
- Git

### 项目结构
```
snowsword-wiki/
├── app.py                    # 主应用
├── src/
│   ├── text_processor.py     # 文本处理（新增）
│   ├── semantic_retriever.py # 语义检索（新增）
│   ├── event_extractor.py    # 事件抽取（新增）
│   ├── knowledge_graph_v2.py # 知识图谱v2（新增）
│   ├── hybrid_retriever.py   # 混合检索（新增）
│   ├── expert_ai_v2.py       # 专家AI v2（新增）
│   └── ...                   # 现有模块
├── data/
│   ├── events.json           # 结构化事件（新增）
│   ├── knowledge_graph_v2.json # 完整图谱（新增）
│   ├── quote_index.json      # 引用索引（新增）
│   └── ...                   # 现有数据
├── prompts/                  # 提示词模板（新增）
├── tests/                    # 测试套件（新增）
├── docs/                     # 文档（新增）
└── docker-compose.yml        # 服务编排（新增）
```

---

## 📚 参考资料

### 开源项目
- **HanLP**: https://github.com/hankcs/HanLP
- **LlamaIndex**: https://github.com/jerryjliu/llama_index
- **BGE Embedding**: https://github.com/FlagOpen/FlagEmbedding
- **Chinese Poetry**: https://github.com/chinese-poetry/chinese-poetry

### 论文
- 《红楼梦》知识图谱构建方法
- 中文小说人物关系抽取研究
- 文学文本的语义分析与主题建模

### 竞品参考
- **SparkNotes**: https://www.sparknotes.com/
- **Shmoop**: https://www.shmoop.com/
- **A Wiki of Ice and Fire**: https://awoiaf.westeros.org/

---

## 👥 人员分工

| 角色 | 职责 | 技能要求 |
|------|------|----------|
| 项目负责人 | 整体规划、进度把控、质量验收 | 项目管理、文学理解 |
| 算法工程师 | NLP模块、知识图谱、检索算法 | Python、NLP、图算法 |
| 后端工程师 | 服务架构、数据库、性能优化 | Python、数据库、DevOps |
| 前端工程师 | Web界面、可视化 | Streamlit、JavaScript |
| 测试工程师 | 测试用例、质量评估 | 测试方法论、文学素养 |

---

## 📝 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-07 | 初始方案 | AI Assistant |

---

## ✅ 待决策事项

1. **是否本地部署大模型？**
   - 方案A: 继续用 DeepSeek API（简单，按量付费）
   - 方案B: 本地部署 ChatGLM3-6B（一次性投入，无后续费用）

2. **图数据库是否必需？**
   - 方案A: 用 Neo4j（功能完整，需Docker）
   - 方案B: 用 NetworkX + JSON（轻量，无额外依赖）

3. **向量数据库选型？**
   - 方案A: ChromaDB（简单，嵌入式）
   - 方案B: FAISS（性能更好，Facebook出品）

4. **Embedding模型？**
   - 方案A: BGE-large-zh（效果SOTA，1.3GB）
   - 方案B: BGE-base-zh（轻量，400MB，效果略差）

---

**备注**: 本文档为项目实施基准，后续变更需记录变更日志。
